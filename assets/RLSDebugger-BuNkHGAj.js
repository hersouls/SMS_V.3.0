import{j as e}from"./radix-PkTNM-lE.js";import{r as s}from"./vendor-CzXpEsbX.js";import{s as t}from"./index-tT6ahxMo.js";import{am as r,a6 as a,aA as l,U as i,C as n,k as c,ag as o,a as d,an as u}from"./icons-ojVkv7w_.js";import"./router-Cv8QkTiH.js";import"./others-B6ceBAQi.js";import"./utils-VH1XAVo5.js";const m=async()=>{try{const{data:{session:e},error:s}=await t.auth.getSession();if(s)return{isAuthenticated:!1,error:s.message,sessionData:null};if(null==e?void 0:e.user){const s=Math.floor(Date.now()/1e3),t=!!e.expires_at&&s>=e.expires_at;return{isAuthenticated:!t,error:null,sessionData:{isAuthenticated:!t,userId:e.user.id,email:e.user.email,role:e.user.role||"authenticated",expiresAt:e.expires_at,isExpired:t,accessToken:e.access_token}}}return{isAuthenticated:!1,error:null,sessionData:null}}catch(e){return{isAuthenticated:!1,error:e instanceof Error?e.message:"Unknown error",sessionData:null}}},h=()=>{const[h,x]=s.useState(null),[g,p]=s.useState([]),[j,b]=s.useState(!1),[w,f]=s.useState(!1),[y,N]=s.useState(null),v=async()=>{var e;try{const s=await m();s.sessionData?x({isAuthenticated:s.isAuthenticated,userId:s.sessionData.userId,email:s.sessionData.email,role:s.sessionData.role,expiresAt:s.sessionData.expiresAt,accessToken:(null==(e=s.sessionData.accessToken)?void 0:e.substring(0,20))+"..."}):x({isAuthenticated:!1})}catch(s){x({isAuthenticated:!1})}};s.useEffect(()=>{v()},[]);const S=(e,s)=>e?"Success":(null==s?void 0:s.includes("Row Level Security policy"))?"RLS Policy Block (Expected for unauthenticated users)":"Failed";return e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-blue-500 to-purple-600 p-4",children:e.jsxs("div",{className:"max-w-4xl mx-auto",children:[e.jsxs("div",{className:"bg-white rounded-lg shadow-lg p-6 mb-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsxs("h1",{className:"text-2xl font-bold text-gray-800 flex items-center",children:[e.jsx(r,{className:"w-8 h-8 mr-3 text-blue-600"}),"RLS (Row Level Security) 디버거"]}),e.jsxs("div",{className:"flex space-x-2",children:[e.jsxs("button",{onClick:async()=>{await(async()=>{try{const{data:{session:e},error:s}=await t.auth.getSession();if(s)return;if(!e)return;const r=Math.floor(Date.now()/1e3),a=e.expires_at,l=a?a-r:0;!(a&&r>=a)&&l>0&&(Math.floor(l/3600),Math.floor(l%3600/60)),e.user.user_metadata&&Object.keys(e.user.user_metadata).length}catch(e){}})(),alert("세션 상세 정보가 콘솔에 출력되었습니다. 개발자 도구(F12)의 콘솔 탭을 확인하세요.")},className:"flex items-center px-3 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700",children:[e.jsx(a,{className:"w-4 h-4 mr-1"}),"세션 상세"]}),e.jsxs("button",{onClick:async()=>{f(!0);try{const{data:e,error:s}=await t.auth.refreshSession();s||await v()}catch(e){}finally{f(!1)}},disabled:w,className:"flex items-center px-3 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50",children:[e.jsx(l,{className:"w-4 h-4 mr-1 "+(w?"animate-spin":"")}),"새로고침"]}),e.jsxs("button",{onClick:v,className:"flex items-center px-3 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700",children:[e.jsx(i,{className:"w-4 h-4 mr-1"}),"인증 확인"]})]})]}),e.jsxs("div",{className:"bg-gray-50 rounded-lg p-4 mb-6",children:[e.jsxs("h2",{className:"text-lg font-semibold mb-3 flex items-center",children:[e.jsx(i,{className:"w-5 h-5 mr-2"}),"인증 상태"]}),h?e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center",children:[h.isAuthenticated?e.jsx(n,{className:"w-5 h-5 text-green-500 mr-2"}):e.jsx(c,{className:"w-5 h-5 text-red-500 mr-2"}),e.jsx("span",{className:"font-medium",children:h.isAuthenticated?"로그인됨":"로그아웃됨"})]}),h.isAuthenticated&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 mt-4",children:[e.jsxs("div",{children:[e.jsx("strong",{children:"사용자 ID:"})," ",h.userId]}),e.jsxs("div",{children:[e.jsx("strong",{children:"이메일:"})," ",h.email]}),e.jsxs("div",{children:[e.jsx("strong",{children:"역할:"})," ",h.role]}),e.jsxs("div",{children:[e.jsx("strong",{children:"만료 시간:"})," ",h.expiresAt?new Date(1e3*h.expiresAt).toLocaleString():"N/A"]})]}),e.jsxs("div",{className:"mt-2",children:[e.jsx("strong",{children:"액세스 토큰:"}),e.jsx("code",{className:"ml-2 text-sm bg-gray-200 px-2 py-1 rounded",children:h.accessToken})]})]})]}):e.jsx("div",{className:"text-gray-500",children:"인증 상태를 확인하는 중..."})]}),e.jsxs("div",{className:"bg-gray-50 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("h2",{className:"text-lg font-semibold flex items-center",children:[e.jsx(o,{className:"w-5 h-5 mr-2"}),"RLS 정책 테스트"]}),e.jsxs("div",{className:"flex space-x-2",children:[e.jsxs("button",{onClick:async()=>{b(!0);try{const e=await(async()=>{const e=await m();if(!e.isAuthenticated)return{success:!1,message:"인증이 필요합니다. 로그인 후 다시 시도하세요.",authStatus:e};const s=[];try{const{data:e,error:r}=await t.from("subscriptions").select("*").limit(5);r?s.push({table:"subscriptions",success:!1,error:r.message,rowCount:0}):s.push({table:"subscriptions",success:!0,error:null,rowCount:(null==e?void 0:e.length)||0})}catch(a){s.push({table:"subscriptions",success:!1,error:a instanceof Error?a.message:"Unknown error",rowCount:0})}try{const{data:e,error:r}=await t.from("user_settings").select("*").limit(5);r?s.push({table:"user_settings",success:!1,error:r.message,rowCount:0}):s.push({table:"user_settings",success:!0,error:null,rowCount:(null==e?void 0:e.length)||0})}catch(a){s.push({table:"user_settings",success:!1,error:a instanceof Error?a.message:"Unknown error",rowCount:0})}try{const{data:e,error:r}=await t.from("notifications").select("*").limit(5);r?s.push({table:"notifications",success:!1,error:r.message,rowCount:0}):s.push({table:"notifications",success:!0,error:null,rowCount:(null==e?void 0:e.length)||0})}catch(a){s.push({table:"notifications",success:!1,error:a instanceof Error?a.message:"Unknown error",rowCount:0})}const r=s.filter(e=>e.success).length;return{success:r>0,message:`${r}/${s.length} 테이블에 성공적으로 접근했습니다.`,authStatus:e,results:s}})();if(N(e),e.results){const s=e.results.map(e=>({table:e.table,operation:"SELECT",success:e.success,error:e.error,rowCount:e.rowCount}));p(s)}}catch(e){}finally{b(!1)}},disabled:j,className:"flex items-center px-3 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:opacity-50",children:[e.jsx(d,{className:"w-4 h-4 mr-1"}),j?"테스트 중...":"로그인 후 테스트"]}),e.jsxs("button",{onClick:async()=>{b(!0);try{const e=await(async()=>{var e;const s=await m(),r=["subscriptions","user_settings","notifications","user_behavior_analytics"],a=[];for(const i of r)try{const{data:r,error:l}=await t.from(i).select("*").limit(1),n={table:i,isAuthenticated:s.isAuthenticated,success:!l,error:null==l?void 0:l.message,rowCount:(null==r?void 0:r.length)||0,rlsBlocked:(null==(e=null==l?void 0:l.message)?void 0:e.includes("Row Level Security policy"))||!1};l&&l.message.includes("Row Level Security policy"),a.push(n)}catch(l){a.push({table:i,isAuthenticated:s.isAuthenticated,success:!1,error:l instanceof Error?l.message:"Unknown error",rowCount:0,rlsBlocked:!1})}return{authStatus:s,results:a,summary:{total:a.length,successful:a.filter(e=>e.success).length,rlsBlocked:a.filter(e=>e.rlsBlocked).length,errors:a.filter(e=>!e.success&&!e.rlsBlocked).length}}})(),s=e.results.map(e=>({table:e.table,operation:"SELECT",success:e.success,error:e.error,rowCount:e.rowCount}));p(s),N(e)}catch(e){}finally{b(!1)}},disabled:j,className:"flex items-center px-3 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 disabled:opacity-50",children:[e.jsx(o,{className:"w-4 h-4 mr-1"}),j?"테스트 중...":"RLS 정책 테스트"]})]})]}),y&&e.jsxs("div",{className:"mb-4 p-3 bg-blue-50 rounded-lg",children:[e.jsx("h3",{className:"font-semibold text-blue-800 mb-2",children:"테스트 결과 요약"}),e.jsx("p",{className:"text-sm text-blue-700",children:y.message}),y.summary&&e.jsxs("div",{className:"mt-2 text-sm text-blue-600",children:["총 ",y.summary.total,"개 테이블 | 성공: ",y.summary.successful,"개 | RLS 차단: ",y.summary.rlsBlocked,"개 | 오류: ",y.summary.errors,"개"]})]}),g.length>0&&e.jsx("div",{className:"space-y-3",children:g.map((s,t)=>{return e.jsxs("div",{className:"bg-white rounded-lg p-4 border",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center",children:[(a=s.success,l=s.error,a?e.jsx(n,{className:"w-5 h-5 text-green-500"}):(null==l?void 0:l.includes("Row Level Security policy"))?e.jsx(r,{className:"w-5 h-5 text-orange-500"}):e.jsx(c,{className:"w-5 h-5 text-red-500"})),e.jsxs("span",{className:"ml-2 font-medium",children:[s.table,".",s.operation]})]}),e.jsx("span",{className:"text-sm text-gray-600",children:S(s.success,s.error)})]}),void 0!==s.rowCount&&e.jsxs("div",{className:"mt-2 text-sm text-gray-600",children:["조회된 행 수: ",s.rowCount]}),s.error&&e.jsxs("div",{className:"mt-2 text-sm text-red-600 bg-red-50 p-2 rounded",children:[e.jsx("strong",{children:"오류:"})," ",s.error]})]},t);var a,l})}),0===g.length&&!j&&e.jsx("div",{className:"text-center text-gray-500 py-8",children:"테스트 버튼을 클릭하여 RLS 정책을 확인하세요."})]})]}),e.jsxs("div",{className:"bg-white rounded-lg shadow-lg p-6",children:[e.jsxs("h2",{className:"text-lg font-semibold mb-4 flex items-center",children:[e.jsx(u,{className:"w-5 h-5 mr-2 text-orange-500"}),"RLS 정책 이해하기"]}),e.jsxs("div",{className:"space-y-4 text-sm text-gray-700",children:[e.jsxs("div",{className:"bg-blue-50 p-4 rounded-lg",children:[e.jsx("h3",{className:"font-semibold text-blue-800 mb-2",children:"✅ 정상적인 RLS 동작"}),e.jsxs("p",{children:['미인증 사용자가 데이터에 접근할 때 "Row Level Security policy" 오류가 발생하는 것은',e.jsx("strong",{children:" 정상적인 보안 설정"}),"입니다. 이는 데이터베이스가 올바르게 보호되고 있음을 의미합니다."]})]}),e.jsxs("div",{className:"bg-green-50 p-4 rounded-lg",children:[e.jsx("h3",{className:"font-semibold text-green-800 mb-2",children:"🔐 해결 방법"}),e.jsxs("ul",{className:"list-disc list-inside space-y-1",children:[e.jsx("li",{children:"사용자가 로그인한 후 데이터에 접근해야 합니다."}),e.jsx("li",{children:"로그인 페이지(/login)에서 인증을 완료하세요."}),e.jsx("li",{children:"인증 후 이 페이지를 다시 방문하여 테스트하세요."})]})]}),e.jsxs("div",{className:"bg-yellow-50 p-4 rounded-lg",children:[e.jsx("h3",{className:"font-semibold text-yellow-800 mb-2",children:"🧪 테스트 방법"}),e.jsxs("ol",{className:"list-decimal list-inside space-y-1",children:[e.jsx("li",{children:'먼저 "인증 확인" 버튼을 클릭하여 현재 로그인 상태를 확인합니다.'}),e.jsx("li",{children:"로그아웃 상태라면 /login 페이지에서 로그인하세요."}),e.jsx("li",{children:'로그인 후 다시 이 페이지로 돌아와서 "로그인 후 테스트"를 클릭합니다.'}),e.jsx("li",{children:"인증된 사용자는 자신의 데이터에 접근할 수 있어야 합니다."}),e.jsx("li",{children:'"세션 상세" 버튼을 클릭하면 콘솔에서 더 자세한 정보를 확인할 수 있습니다.'})]})]}),e.jsxs("div",{className:"bg-purple-50 p-4 rounded-lg",children:[e.jsx("h3",{className:"font-semibold text-purple-800 mb-2",children:"🎯 빠른 테스트"}),e.jsx("p",{className:"mb-2",children:"다음 코드를 브라우저 콘솔에서 직접 실행할 수 있습니다:"}),e.jsx("code",{className:"block bg-gray-100 p-2 rounded text-xs",children:"// 인증 상태 확인\nconst { data: { session } } = await supabase.auth.getSession();\nconsole.log('세션 상태:', session ? '로그인됨' : '로그아웃됨');"})]})]})]})]})})};export{h as RLSDebugger};
