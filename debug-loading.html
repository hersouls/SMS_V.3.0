<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Moonwave ë¡œë”© ë””ë²„ê·¸</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
        }
        
        .container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }
        
        .log {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        button {
            background: linear-gradient(45deg, #FF6B6B, #4ECDC4);
            border: none;
            color: white;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            margin: 10px 5px;
        }
        
        .status {
            display: flex;
            justify-content: space-between;
            margin: 20px 0;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }
        
        .status-item {
            text-align: center;
        }
        
        .status-value {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .status-label {
            font-size: 12px;
            opacity: 0.8;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸŒŠ Moonwave ë¡œë”© ìƒíƒœ ë””ë²„ê·¸</h1>
        
        <div class="status">
            <div class="status-item">
                <div class="status-value" id="auth-status">â“</div>
                <div class="status-label">ì¸ì¦ ìƒíƒœ</div>
            </div>
            <div class="status-item">
                <div class="status-value" id="loading-status">â“</div>
                <div class="status-label">ë¡œë”© ìƒíƒœ</div>
            </div>
            <div class="status-item">
                <div class="status-value" id="data-status">â“</div>
                <div class="status-label">ë°ì´í„° ìƒíƒœ</div>
            </div>
        </div>
        
        <input type="email" id="email-input" placeholder="ì´ë©”ì¼ ì£¼ì†Œ ì…ë ¥" style="width: 300px; padding: 10px; margin: 10px; border-radius: 5px; border: none; color: black;">
        <br>
        <button onclick="checkAuthStatus()">ì¸ì¦ ìƒíƒœ í™•ì¸</button>
        <button onclick="quickLogin()">ê¸°ì¡´ ê³„ì • ë¹ ë¥¸ ë¡œê·¸ì¸</button>
        <button onclick="sendMagicLink()">Magic Link ì „ì†¡</button>
        <button onclick="manualAuth()">ìˆ˜ë™ ì¸ì¦ (ì½”ë“œ ì…ë ¥)</button>
        <hr style="margin: 20px 0; border: 1px solid rgba(255,255,255,0.2);">
        <h3>ğŸ§ª êµ¬ë… ê´€ë¦¬ í…ŒìŠ¤íŠ¸ (ì¸ì¦ ì—†ì´)</h3>
        <button onclick="testCreateSubscription()">êµ¬ë… ìƒì„± í…ŒìŠ¤íŠ¸</button>
        <button onclick="testGetSubscriptions()">êµ¬ë… ì¡°íšŒ í…ŒìŠ¤íŠ¸</button>
        <button onclick="testFullCRUD()">ì „ì²´ CRUD í…ŒìŠ¤íŠ¸</button>
        <button onclick="bypassRLS()">RLS ìš°íšŒ í…ŒìŠ¤íŠ¸</button>
        <hr style="margin: 20px 0; border: 1px solid rgba(255,255,255,0.2);">
        <button onclick="checkDataLoading()">ë°ì´í„° ë¡œë”© í™•ì¸</button>
        <button onclick="testApiCall()">API í˜¸ì¶œ í…ŒìŠ¤íŠ¸</button>
        <button onclick="clearLog()">ë¡œê·¸ ì§€ìš°ê¸°</button>
        
        <div id="log" class="log"></div>
    </div>

    <script type="module">
        // Supabase í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™”
        import { createClient } from 'https://cdn.skypack.dev/@supabase/supabase-js@2';
        
        const SUPABASE_URL = 'https://bfurhjgnnjgfcafdrotk.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJmdXJoamdubmpnZmNhZmRyb3RrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM2MDQ4NTIsImV4cCI6MjA2OTE4MDg1Mn0.mxP7V92XRdY8e_7r9GR3B04blukhVf1vu_teRguv20U';
        
        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        function log(message) {
            const logElement = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logElement.innerHTML += `[${timestamp}] ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
        }
        
        function updateStatus(elementId, value, color) {
            const element = document.getElementById(elementId);
            element.textContent = value;
            element.style.color = color;
        }
        
        // ì¸ì¦ ìƒíƒœ í™•ì¸
        window.checkAuthStatus = async function() {
            log('ğŸ” ì¸ì¦ ìƒíƒœ í™•ì¸ ì¤‘...');
            
            try {
                const { data: { session }, error } = await supabase.auth.getSession();
                
                if (error) {
                    log(`âŒ ì„¸ì…˜ ì˜¤ë¥˜: ${error.message}`);
                    updateStatus('auth-status', 'âŒ', '#FF6B6B');
                    return;
                }
                
                if (session && session.user) {
                    log(`âœ… ì¸ì¦ë¨: ${session.user.email}`);
                    log(`ğŸ†” ì‚¬ìš©ì ID: ${session.user.id}`);
                    log(`â° ë¡œê·¸ì¸ ì‹œê°„: ${new Date(session.user.last_sign_in_at).toLocaleString()}`);
                    updateStatus('auth-status', 'âœ…', '#4ECDC4');
                    
                    // ìë™ìœ¼ë¡œ ë°ì´í„° ë¡œë”© í…ŒìŠ¤íŠ¸
                    setTimeout(() => checkDataLoading(), 1000);
                } else {
                    log('âŒ ì¸ì¦ë˜ì§€ ì•Šì€ ìƒíƒœ');
                    updateStatus('auth-status', 'âŒ', '#FF6B6B');
                }
            } catch (error) {
                log(`ğŸ’¥ ì¸ì¦ í™•ì¸ ì‹¤íŒ¨: ${error.message}`);
                updateStatus('auth-status', 'ğŸ’¥', '#FF6B6B');
            }
        };
        
        // ë°ì´í„° ë¡œë”© í™•ì¸
        window.checkDataLoading = async function() {
            log('ğŸ“Š ë°ì´í„° ë¡œë”© ìƒíƒœ í™•ì¸ ì¤‘...');
            updateStatus('loading-status', 'ğŸ”„', '#FFA500');
            
            try {
                // êµ¬ë… ë°ì´í„° ë¡œë”©
                log('ğŸ“‹ êµ¬ë… ëª©ë¡ ë¡œë”©...');
                const { data: subscriptions, error: subError } = await supabase
                    .from('subscriptions')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (subError) {
                    log(`âŒ êµ¬ë… ë¡œë”© ì‹¤íŒ¨: ${subError.message}`);
                    updateStatus('data-status', 'âŒ', '#FF6B6B');
                    return;
                }
                
                log(`âœ… êµ¬ë… ${subscriptions.length}ê°œ ë¡œë”© ì™„ë£Œ`);
                
                // ì‚¬ìš©ì ì„¤ì • ë¡œë”©
                log('âš™ï¸ ì‚¬ìš©ì ì„¤ì • ë¡œë”©...');
                const { data: preferences, error: prefError } = await supabase
                    .from('user_preferences')
                    .select('*')
                    .single();
                
                if (prefError && prefError.code !== 'PGRST116') {
                    log(`âŒ ì„¤ì • ë¡œë”© ì‹¤íŒ¨: ${prefError.message}`);
                } else {
                    log('âœ… ì‚¬ìš©ì ì„¤ì • ë¡œë”© ì™„ë£Œ');
                }
                
                // ì•Œë¦¼ ë¡œë”©
                log('ğŸ”” ì•Œë¦¼ ë¡œë”©...');
                const { data: notifications, error: notifError } = await supabase
                    .from('notifications')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (notifError) {
                    log(`âŒ ì•Œë¦¼ ë¡œë”© ì‹¤íŒ¨: ${notifError.message}`);
                } else {
                    log(`âœ… ì•Œë¦¼ ${notifications.length}ê°œ ë¡œë”© ì™„ë£Œ`);
                }
                
                updateStatus('loading-status', 'âœ…', '#4ECDC4');
                updateStatus('data-status', `${subscriptions.length}ê°œ`, '#4ECDC4');
                
                log('ğŸ‰ ëª¨ë“  ë°ì´í„° ë¡œë”© ì™„ë£Œ!');
                
            } catch (error) {
                log(`ğŸ’¥ ë°ì´í„° ë¡œë”© ì‹¤íŒ¨: ${error.message}`);
                updateStatus('loading-status', 'ğŸ’¥', '#FF6B6B');
                updateStatus('data-status', 'ğŸ’¥', '#FF6B6B');
            }
        };
        
        // ê¸°ì¡´ ê³„ì • ë¹ ë¥¸ ë¡œê·¸ì¸
        window.quickLogin = async function() {
            const email = document.getElementById('email-input').value || 'her_soul@naver.com';
            
            log(`ğŸš€ ê¸°ì¡´ ê³„ì •ìœ¼ë¡œ ë¹ ë¥¸ ë¡œê·¸ì¸ ì‹œë„: ${email}`);
            log('ğŸ’¡ ì´ë¯¸ ë“±ë¡ëœ ê³„ì •ì´ë¯€ë¡œ Magic Linkë§Œ ì „ì†¡í•©ë‹ˆë‹¤.');
            
            try {
                const { data, error } = await supabase.auth.signInWithOtp({
                    email: email,
                    options: {
                        shouldCreateUser: false // ê¸°ì¡´ ì‚¬ìš©ìë§Œ
                    }
                });
                
                if (error) {
                    if (error.message.includes('User not found')) {
                        log('âŒ ë“±ë¡ë˜ì§€ ì•Šì€ ì´ë©”ì¼ì…ë‹ˆë‹¤.');
                        log('ğŸ’¡ her_soul@naver.com ê³„ì •ì„ ì‚¬ìš©í•´ë³´ì„¸ìš”.');
                    } else {
                        throw error;
                    }
                    return;
                }
                
                log('âœ… Magic Link ì „ì†¡ ì„±ê³µ!');
                log('ğŸ“§ ì´ë©”ì¼ì„ í™•ì¸í•˜ì„¸ìš”. (ì‹¤ì œ ì´ë©”ì¼ì´ ì•„ë‹ˆë©´ ë¬´ì‹œí•˜ê³  ë‹¤ë¥¸ ë°©ë²• ì‚¬ìš©)');
                log('');
                log('ğŸ¯ ëŒ€ì•ˆ: ì•„ë˜ "ì „ì²´ CRUD í…ŒìŠ¤íŠ¸" ë²„íŠ¼ìœ¼ë¡œ ì¸ì¦ ì—†ì´ í…ŒìŠ¤íŠ¸í•˜ì„¸ìš”!');
                
            } catch (error) {
                log(`ğŸ’¥ ë¹ ë¥¸ ë¡œê·¸ì¸ ì‹¤íŒ¨: ${error.message}`);
                log('ğŸ¯ ì¸ì¦ ì—†ì´ "ì „ì²´ CRUD í…ŒìŠ¤íŠ¸"ë¥¼ ì‹œë„í•´ë³´ì„¸ìš”!');
            }
        };
        
        // ìˆ˜ë™ ì¸ì¦ (Magic Link í† í°ìœ¼ë¡œ)
        window.manualAuth = async function() {
            const input = prompt('Magic Linkì—ì„œ í† í°ì„ ì…ë ¥í•˜ì„¸ìš”:\n\nOAuth ì½”ë“œ (ì˜ˆ: f5353283-45d4-4058-8293-04b7aeed722d)\në˜ëŠ”\nMagic Link í† í° (ì˜ˆ: a01e6c19751e2164e9d6f4daf2456b104ff36c87cb6bda4aa1e0a5d5)');
            
            if (!input) {
                log('âŒ í† í°ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            log(`ğŸ” ìˆ˜ë™ ì¸ì¦ ì‹œë„ ì¤‘... (í† í°: ${input.substring(0, 8)}...)`);
            
            try {
                // OAuth ì½”ë“œì¸ì§€ Magic Link í† í°ì¸ì§€ íŒë³„
                if (input.includes('-') && input.length > 30) {
                    // OAuth ì½”ë“œë¡œ íŒë‹¨
                    log('ğŸ” OAuth ì½”ë“œë¡œ ì¸ì‹ë¨');
                    const { data, error } = await supabase.auth.exchangeCodeForSession(input);
                    
                    if (error) throw error;
                    
                    if (data.session && data.session.user) {
                        log('âœ… OAuth ì¸ì¦ ì„±ê³µ!');
                        log(`ğŸ‘¤ ì‚¬ìš©ì: ${data.session.user.email}`);
                        log(`ğŸ†” ID: ${data.session.user.id}`);
                        updateStatus('auth-status', 'âœ…', '#4ECDC4');
                        setTimeout(() => checkDataLoading(), 1000);
                    }
                } else {
                    // Magic Link í† í°ìœ¼ë¡œ íŒë‹¨
                    log('ğŸ” Magic Link í† í°ìœ¼ë¡œ ì¸ì‹ë¨');
                    
                    // Magic Link í† í°ì„ ì§ì ‘ ê²€ì¦
                    const response = await fetch(`https://bfurhjgnnjgfcafdrotk.supabase.co/auth/v1/verify`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJmdXJoamdubmpnZmNhZmRyb3RrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM2MDQ4NTIsImV4cCI6MjA2OTE4MDg1Mn0.mxP7V92XRdY8e_7r9GR3B04blukhVf1vu_teRguv20U'
                        },
                        body: JSON.stringify({
                            token: input,
                            type: 'magiclink'
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error(`Magic Link ê²€ì¦ ì‹¤íŒ¨: ${response.status}`);
                    }
                    
                    const result = await response.json();
                    log('âœ… Magic Link ê²€ì¦ ì„±ê³µ!');
                    log('ğŸ”„ ì„¸ì…˜ ìƒˆë¡œê³ ì¹¨ ì¤‘...');
                    
                    // ì„¸ì…˜ ìƒˆë¡œê³ ì¹¨
                    const { data: session } = await supabase.auth.refreshSession();
                    if (session.session) {
                        log('âœ… ì„¸ì…˜ ìƒˆë¡œê³ ì¹¨ ì„±ê³µ!');
                        updateStatus('auth-status', 'âœ…', '#4ECDC4');
                        setTimeout(() => checkDataLoading(), 1000);
                    }
                }
                
            } catch (error) {
                log(`ğŸ’¥ ìˆ˜ë™ ì¸ì¦ ì˜¤ë¥˜: ${error.message}`);
                log('ğŸ’¡ ë‹¤ë¥¸ ë°©ë²•ì„ ì‹œë„í•´ë³´ì„¸ìš”:');
                log('1. Google OAuth ë¡œê·¸ì¸');
                log('2. ìƒˆë¡œìš´ Magic Link ìš”ì²­');
                log('3. ì¸ì¦ ì—†ì´ API í…ŒìŠ¤íŠ¸');
            }
        };
        
        // Magic Link ì „ì†¡
        window.sendMagicLink = async function() {
            const email = document.getElementById('email-input').value;
            if (!email) {
                log('âŒ ì´ë©”ì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            log(`ğŸ“§ Magic Link ì „ì†¡ ì¤‘... (${email})`);
            
            try {
                const { data, error } = await supabase.auth.signInWithOtp({
                    email: email,
                    options: {
                        emailRedirectTo: 'http://localhost:3003/auth/callback'
                    }
                });
                
                if (error) {
                    log(`âŒ Magic Link ì „ì†¡ ì‹¤íŒ¨: ${error.message}`);
                    return;
                }
                
                log('âœ… Magic Link ì „ì†¡ ì„±ê³µ!');
                log('ğŸ“¬ ì´ë©”ì¼ì„ í™•ì¸í•˜ê³  ë§í¬ë¥¼ í´ë¦­í•˜ì„¸ìš”.');
                log('ğŸ”„ ë§í¬ í´ë¦­ í›„ ì´ í˜ì´ì§€ì—ì„œ "ì¸ì¦ ìƒíƒœ í™•ì¸"ì„ ë‹¤ì‹œ ëˆŒëŸ¬ë³´ì„¸ìš”.');
                
            } catch (error) {
                log(`ğŸ’¥ Magic Link ì „ì†¡ ì‹¤íŒ¨: ${error.message}`);
            }
        };
        
        // API í˜¸ì¶œ í…ŒìŠ¤íŠ¸
        window.testApiCall = async function() {
            log('ğŸ§ª API í˜¸ì¶œ í…ŒìŠ¤íŠ¸...');
            
            try {
                // ì—°ê²° í…ŒìŠ¤íŠ¸
                const { data, error } = await supabase
                    .from('subscriptions')
                    .select('count')
                    .limit(1);
                
                if (error) {
                    log(`âŒ API í˜¸ì¶œ ì‹¤íŒ¨: ${error.message}`);
                    return;
                }
                
                log('âœ… API í˜¸ì¶œ ì„±ê³µ');
                
                // RLS ì •ì±… í…ŒìŠ¤íŠ¸
                const { data: testData, error: testError } = await supabase
                    .from('subscriptions')
                    .select('*')
                    .limit(1);
                
                if (testError) {
                    log(`âš ï¸ RLS ì •ì±… ì°¨ë‹¨: ${testError.message}`);
                    log('ğŸ’¡ ì´ëŠ” ì •ìƒì ì¸ ë³´ì•ˆ ë™ì‘ì…ë‹ˆë‹¤.');
                } else {
                    log('âœ… ë°ì´í„° ì ‘ê·¼ í—ˆìš©ë¨');
                }
                
            } catch (error) {
                log(`ğŸ’¥ API í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: ${error.message}`);
            }
        };
        
        // êµ¬ë… ìƒì„± í…ŒìŠ¤íŠ¸
        window.testCreateSubscription = async function() {
            log('ğŸ“‹ êµ¬ë… ìƒì„± í…ŒìŠ¤íŠ¸ ì‹œì‘...');
            
            const testSub = {
                service_name: 'Netflix í…ŒìŠ¤íŠ¸',
                service_url: 'https://netflix.com',
                logo: 'ğŸ¬',
                amount: 15900,
                currency: 'KRW',
                payment_cycle: 'monthly',
                payment_day: 15,
                payment_method: 'ì‹ ìš©ì¹´ë“œ',
                start_date: '2024-01-15',
                auto_renewal: true,
                status: 'active',
                category: 'ì—”í„°í…Œì¸ë¨¼íŠ¸',
                tier: 'Premium',
                tags: ['ë™ì˜ìƒ', 'ìŠ¤íŠ¸ë¦¬ë°'],
                memo: 'ë””ë²„ê·¸ ë„êµ¬ì—ì„œ ìƒì„±í•œ í…ŒìŠ¤íŠ¸ êµ¬ë…',
                notifications: { sevenDays: true, threeDays: true, sameDay: true }
            };
            
            try {
                const { data, error } = await supabase
                    .from('subscriptions')
                    .insert(testSub)
                    .select()
                    .single();
                
                if (error) throw error;
                
                log(`âœ… êµ¬ë… ìƒì„± ì„±ê³µ!`);
                log(`ğŸ†” ID: ${data.id}`);
                log(`ğŸ¬ ì„œë¹„ìŠ¤: ${data.service_name}`);
                log(`ğŸ’° ê¸ˆì•¡: ${data.amount.toLocaleString()}ì›/ì›”`);
                log(`ğŸ“… ê²°ì œì¼: ë§¤ì›” ${data.payment_day}ì¼`);
                
                return data.id;
            } catch (error) {
                log(`âŒ êµ¬ë… ìƒì„± ì‹¤íŒ¨: ${error.message}`);
                return null;
            }
        };
        
        // êµ¬ë… ì¡°íšŒ í…ŒìŠ¤íŠ¸
        window.testGetSubscriptions = async function() {
            log('ğŸ“Š êµ¬ë… ëª©ë¡ ì¡°íšŒ í…ŒìŠ¤íŠ¸...');
            
            try {
                const { data, error } = await supabase
                    .from('subscriptions')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(10);
                
                if (error) throw error;
                
                log(`âœ… êµ¬ë… ì¡°íšŒ ì„±ê³µ! (${data.length}ê°œ)`);
                
                if (data.length > 0) {
                    log('\nğŸ“‹ êµ¬ë… ëª©ë¡:');
                    data.forEach((sub, index) => {
                        log(`  ${index + 1}. ${sub.service_name}`);
                        log(`     ğŸ’° ${sub.amount.toLocaleString()}${sub.currency} (${sub.payment_cycle})`);
                        log(`     ğŸ“… ë§¤ì›” ${sub.payment_day}ì¼`);
                        log(`     ğŸ”– ${sub.category} | ${sub.status}`);
                        log(`     ğŸ†” ${sub.id}`);
                        log('');
                    });
                } else {
                    log('ğŸ“ ë“±ë¡ëœ êµ¬ë…ì´ ì—†ìŠµë‹ˆë‹¤.');
                }
                
                return data;
            } catch (error) {
                log(`âŒ êµ¬ë… ì¡°íšŒ ì‹¤íŒ¨: ${error.message}`);
                return [];
            }
        };
        
        // ì „ì²´ CRUD í…ŒìŠ¤íŠ¸
        window.testFullCRUD = async function() {
            log('ğŸš€ ì „ì²´ êµ¬ë… ê´€ë¦¬ CRUD í…ŒìŠ¤íŠ¸ ì‹œì‘!');
            log('='.repeat(40));
            
            let createdId = null;
            
            try {
                // 1. Create (ìƒì„±)
                log('\n1ï¸âƒ£ êµ¬ë… ìƒì„±...');
                createdId = await testCreateSubscription();
                
                if (!createdId) {
                    log('âŒ ìƒì„± ì‹¤íŒ¨ë¡œ í…ŒìŠ¤íŠ¸ ì¤‘ë‹¨');
                    return;
                }
                
                // 2. Read (ì¡°íšŒ)
                log('\n2ï¸âƒ£ êµ¬ë… ì¡°íšŒ...');
                const subscriptions = await testGetSubscriptions();
                
                // 3. Update (ìˆ˜ì •)
                log('\n3ï¸âƒ£ êµ¬ë… ìˆ˜ì •...');
                const updateData = {
                    amount: 17900,
                    tier: 'Premium Plus',
                    memo: 'ìˆ˜ì •ëœ í…ŒìŠ¤íŠ¸ êµ¬ë… - ' + new Date().toLocaleString()
                };
                
                const { data: updated, error: updateError } = await supabase
                    .from('subscriptions')
                    .update(updateData)
                    .eq('id', createdId)
                    .select()
                    .single();
                
                if (updateError) throw updateError;
                
                log('âœ… êµ¬ë… ìˆ˜ì • ì„±ê³µ!');
                log(`ğŸ’° ìˆ˜ì •ëœ ê¸ˆì•¡: ${updated.amount.toLocaleString()}ì›`);
                log(`ğŸ·ï¸ ìˆ˜ì •ëœ í‹°ì–´: ${updated.tier}`);
                
                // 4. Delete (ì‚­ì œ)
                log('\n4ï¸âƒ£ êµ¬ë… ì‚­ì œ...');
                const { error: deleteError } = await supabase
                    .from('subscriptions')
                    .delete()
                    .eq('id', createdId);
                
                if (deleteError) throw deleteError;
                
                log('âœ… êµ¬ë… ì‚­ì œ ì„±ê³µ!');
                log(`ğŸ—‘ï¸ ì‚­ì œëœ ID: ${createdId}`);
                
                // 5. ìµœì¢… í™•ì¸
                log('\n5ï¸âƒ£ ì‚­ì œ í™•ì¸...');
                const { data: checkData } = await supabase
                    .from('subscriptions')
                    .select('*')
                    .eq('id', createdId);
                
                if (!checkData || checkData.length === 0) {
                    log('âœ… ì‚­ì œ í™•ì¸ë¨!');
                } else {
                    log('âš ï¸ ì‚­ì œê°€ ì™„ì „í•˜ì§€ ì•ŠìŒ');
                }
                
                log('\nğŸ‰ ì „ì²´ CRUD í…ŒìŠ¤íŠ¸ ì™„ë£Œ!');
                log('ğŸ“Š í…ŒìŠ¤íŠ¸ ê²°ê³¼:');
                log('âœ… ìƒì„± (Create): ì„±ê³µ');
                log('âœ… ì¡°íšŒ (Read): ì„±ê³µ');
                log('âœ… ìˆ˜ì • (Update): ì„±ê³µ');
                log('âœ… ì‚­ì œ (Delete): ì„±ê³µ');
                log('\nğŸš€ êµ¬ë… ê´€ë¦¬ ì‹œìŠ¤í…œì´ ì™„ë²½í•˜ê²Œ ì‘ë™í•©ë‹ˆë‹¤!');
                
            } catch (error) {
                log(`ğŸ’¥ CRUD í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: ${error.message}`);
                
                // ì •ë¦¬
                if (createdId) {
                    try {
                        await supabase.from('subscriptions').delete().eq('id', createdId);
                        log('ğŸ§¹ í…ŒìŠ¤íŠ¸ ë°ì´í„° ì •ë¦¬ ì™„ë£Œ');
                    } catch (cleanupError) {
                        log('âš ï¸ í…ŒìŠ¤íŠ¸ ë°ì´í„° ì •ë¦¬ ì‹¤íŒ¨');
                    }
                }
            }
        };
        
        // RLS ìš°íšŒ í…ŒìŠ¤íŠ¸ (Service Role í‚¤ ì‚¬ìš©)
        window.bypassRLS = async function() {
            log('ğŸ”“ RLS ìš°íšŒ í…ŒìŠ¤íŠ¸ ì‹œì‘...');
            log('âš ï¸ ì´ê²ƒì€ ê°œë°œ/í…ŒìŠ¤íŠ¸ ëª©ì ë§Œì„ ìœ„í•œ ê¸°ëŠ¥ì…ë‹ˆë‹¤.');
            
            try {
                // Service Role í‚¤ë¡œ ìƒˆ í´ë¼ì´ì–¸íŠ¸ ìƒì„±
                const serviceClient = createClient(
                    'https://bfurhjgnnjgfcafdrotk.supabase.co',
                    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJmdXJoamdubmpnZmNhZmRyb3RrIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1MzYwNDg1MiwiZXhwIjoyMDY5MTgwODUyfQ.zzDATOqoatQYPjpCTv8RezLqHmYldBrX2NrZ5ZA9wpA'
                );
                
                log('ğŸ”‘ Service Role í‚¤ë¡œ ê´€ë¦¬ì ê¶Œí•œ í…ŒìŠ¤íŠ¸...');
                
                // ë¨¼ì € ì‹¤ì œ ì‚¬ìš©ì ì°¾ê¸°
                log('ğŸ‘¤ ì‹¤ì œ ì‚¬ìš©ì ID ì¡°íšŒ ì¤‘...');
                const { data: users, error: userError } = await serviceClient.auth.admin.listUsers();
                
                let userId = null;
                if (userError) {
                    log('âš ï¸ ì‚¬ìš©ì ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨, ì„ì‹œ UUID ì‚¬ìš©');
                    userId = crypto.randomUUID(); // ëœë¤ UUID ìƒì„±
                } else if (users.users && users.users.length > 0) {
                    userId = users.users[0].id;
                    log(`âœ… ì‹¤ì œ ì‚¬ìš©ì ID ì‚¬ìš©: ${userId}`);
                } else {
                    userId = crypto.randomUUID();
                    log('âš ï¸ ë“±ë¡ëœ ì‚¬ìš©ì ì—†ìŒ, ëœë¤ UUID ìƒì„±');
                }
                
                const testSub = {
                    service_name: 'RLS ìš°íšŒ í…ŒìŠ¤íŠ¸',
                    service_url: 'https://test.com',
                    logo: 'ğŸ§ª',
                    amount: 9900,
                    currency: 'KRW',
                    payment_cycle: 'monthly',
                    payment_day: 1,
                    payment_method: 'í…ŒìŠ¤íŠ¸',
                    start_date: '2024-01-01',
                    auto_renewal: true,
                    status: 'active',
                    category: 'í…ŒìŠ¤íŠ¸',
                    tier: 'Test',
                    tags: ['í…ŒìŠ¤íŠ¸'],
                    memo: 'RLS ìš°íšŒ í…ŒìŠ¤íŠ¸ìš© ë°ì´í„°',
                    notifications: { sevenDays: true, threeDays: true, sameDay: true },
                    user_id: userId
                };
                
                // ìƒì„± í…ŒìŠ¤íŠ¸
                const { data: created, error: createError } = await serviceClient
                    .from('subscriptions')
                    .insert(testSub)
                    .select()
                    .single();
                
                if (createError) {
                    log(`âŒ RLS ìš°íšŒ ìƒì„± ì‹¤íŒ¨: ${createError.message}`);
                    return;
                }
                
                log('âœ… RLS ìš°íšŒ ìƒì„± ì„±ê³µ!');
                log(`ğŸ†” ID: ${created.id}`);
                
                // ì¡°íšŒ í…ŒìŠ¤íŠ¸
                const { data: list, error: listError } = await serviceClient
                    .from('subscriptions')
                    .select('*')
                    .eq('id', created.id);
                
                if (listError) {
                    log(`âŒ ì¡°íšŒ ì‹¤íŒ¨: ${listError.message}`);
                } else {
                    log('âœ… ì¡°íšŒ ì„±ê³µ!');
                }
                
                // ì‚­ì œ (ì •ë¦¬)
                const { error: deleteError } = await serviceClient
                    .from('subscriptions')
                    .delete()
                    .eq('id', created.id);
                
                if (deleteError) {
                    log(`âš ï¸ ì‚­ì œ ì‹¤íŒ¨: ${deleteError.message}`);
                } else {
                    log('âœ… í…ŒìŠ¤íŠ¸ ë°ì´í„° ì‚­ì œ ì™„ë£Œ');
                }
                
                log('ğŸ‰ RLS ìš°íšŒ í…ŒìŠ¤íŠ¸ ì™„ë£Œ!');
                log('ğŸ’¡ ì´ê²ƒì€ ê´€ë¦¬ì ê¶Œí•œìœ¼ë¡œ RLSë¥¼ ìš°íšŒí•œ ê²ƒì…ë‹ˆë‹¤.');
                log('ğŸ”’ ì‹¤ì œ ì•±ì—ì„œëŠ” ì¸ì¦ëœ ì‚¬ìš©ìë§Œ ë°ì´í„°ë¥¼ ì¡°ì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                
            } catch (error) {
                log(`ğŸ’¥ RLS ìš°íšŒ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: ${error.message}`);
            }
        };
        
        // ë¡œê·¸ ì§€ìš°ê¸°
        window.clearLog = function() {
            document.getElementById('log').innerHTML = '';
        };
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ í™•ì¸
        log('ğŸŒŠ Moonwave ë””ë²„ê·¸ ë„êµ¬ ì‹œì‘');
        log('ğŸ” ìë™ìœ¼ë¡œ ì¸ì¦ ìƒíƒœë¥¼ í™•ì¸í•©ë‹ˆë‹¤...');
        checkAuthStatus();
    </script>
</body>
</html>